#!/bin/bash

error=0; trap 'error=$(($?>$error?$?:$error))' ERR # save maximum error code

echo "A"

ls -la $target/root

$ROOTCMD gpg --list-keys

echo "B"

ls -la $target/root

cat > $target/dbr <<-EOF
     %echo Generating a basic OpenPGP key
     Key-Type: DSA
     Key-Length: 1024
     Subkey-Type: ELG-E
     Subkey-Length: 1024
     Name-Real: Registry
     Expire-Date: 0
     Passphrase: ${ROOTPW}
     %commit
     %echo done
EOF

$ROOTCMD gpg --batch --generate-key dbr

#echo "key generated"

#$ROOTCMD gpg --with-colons --keyid-format=short --list-keys registry

sub_key=$($ROOTCMD gpg --with-colons --keyid-format=short --list-keys dbr | grep sub | head -1 | cut -d':' -f5)

#echo "key is $sub_key"

#ls -la $target

mv $target/dbr $target/root/.gnupg/dbr

mkdir -p $target/var/www/repos/apt/debian/conf

# fixme with fcopy
cat > $target/var/www/repos/apt/debian/conf/override.dbr <<EOF
dbr Priority optional
dbr Section net
EOF

cat > $target/var/www/repos/apt/debian/conf/distributions <<-EOF
Origin: OS-64
Codename: dbr
Architectures: amd64 arm64
Components: main
Description: OS-64 REGISTRY
SignWith: ${sub_key}
DebOverride: override.dbr
EOF

$ROOTCMD gpg --armor --output /var/www/repos/apt/debian/registry.gpg.key --export $sub_key

#echo "key exported"

#$ROOTCMD gpg --armor --output ./registry.gpg.key --export $sub_key
#mv $target/registry.gpg.key $target/var/www/repos/apt/debian/registry.gpg.key

#ls -la $target/var/www/repos/apt/debian

#ls -la $target/var/www/repos/apt/debian

echo "A"

echo ${ROOTPW} | gpg --no-use-agent -o /dev/null --local-user $sub_key -as - && :

echo "B"

$ROOTCMD reprepro -b /var/www/repos/apt/debian export

echo "C"

#PINENTRY_USER_DATA="--pinentry-mode=loopback --passphrase ${ROOTPW}" $ROOTCMD reprepro -b /var/www/repos/apt/debian export


exit $error

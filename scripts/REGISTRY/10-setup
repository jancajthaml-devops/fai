#!/bin/bash

ifclass OS-64 || exit 0

error=0; trap 'error=$(($?>$error?$?:$error))' ERR # save maximum error code

$ROOTCMD gpg --list-keys

distro=$($ROOTCMD lsb_release -sc)

$ROOTCMD cat > /root/.gnupg/gpg-agent.conf <<-EOF
default-cache-ttl 46000
pinentry-program /usr/bin/pinentry
EOF

$ROOTCMD gpg-connect-agent reloadagent /bye

passphrase=$($ROOTCMD openssl rand -base64 32)

cat > $target/registry <<-EOF
     %echo Generating a basic OpenPGP key
     Key-Type: DSA
     Key-Length: 1024
     Subkey-Type: ELG-E
     Subkey-Length: 1024
     Name-Real: Registry
     Expire-Date: 0
     Passphrase: ${passphrase}
     %commit
     %echo done
EOF

$ROOTCMD gpg --batch --generate-key registry && rm $target/registry

sub_key=$($ROOTCMD gpg --with-colons --keyid-format=short --list-keys registry | grep sub | head -1 | cut -d':' -f5)

mkdir -p $target/var/www/repos/apt/debian/conf

cat > $target/var/www/repos/apt/debian/conf/override.${distro} <<EOF
${distro} Priority optional
${distro} Section net
EOF

cat > $target/var/www/repos/apt/debian/conf/distributions <<-EOF
Origin: OS-64
Codename: ${distro}
Architectures: amd64 arm64
Components: main
Description: OS-64 REGISTRY
SignWith: ${sub_key}
DebOverride: override.${distro}
EOF

cat > $target/var/www/repos/apt/debian/conf/options <<-EOF
verbose
ask-passphrase
EOF

cat $target/var/www/repos/apt/debian/conf/distributions
ls -la $target/var/www/repos/apt/debian/conf

$ROOTCMD gpg --armor --output /var/www/repos/apt/debian/registry.gpg.key --export $sub_key

echo "A"

#$ROOTCMD reprepro -b /var/www/repos/apt/debian export

#echo "B"

fcopy -iM /usr/sbin/reporepro_auto

$ROOTCMD cat /usr/sbin/reporepro_auto

echo "SIGNING_PASSWORD=${passphrase}"

$ROOTCMD SIGNING_PASSWORD=${passphrase} /usr/sbin/reporepro_auto  -b /var/www/repos/apt/debian export

echo "B"

exit $error
